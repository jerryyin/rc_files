version: "3.4"
services:
  #tools:
  #  build:
  #    context: .
  #    dockerfile: tools.Dockerfile
  #    args:
  #      UBUNTU_VERSION: "20.04"
  #  image: jeryin/tools:ubuntu-20.04
  #  container_name: zyin-tools
  #  volumes:
  #    - /usr/local:/usr/local
  #  environment:
  #    - PATH=/usr/local/bin:$PATH
  #  # Optionally specify commands to test the tools
  #  command: ["/bin/sh", "-c", "ctags --version && global --version && gdb --version"]

  dev:
    build:
      context: .
      cache_from: 
        - "jeryin/dev:mlir-latest"
      dockerfile: Dockerfile
    image: "jeryin/dev:mlir-latest"
    container_name: ${COMPOSE_PROJECT_NAME:-dev}
    hostname: ${USER:-zyin}
    command: ["/bin/zsh"]  # or whatever command you want to run
    tty: true
    stdin_open: true
    network_mode: host
    devices:
      - /dev/kfd
      - /dev/dri
    group_add:
      - video
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    tmpfs: # Temporary filesystem for VS Code server to improve performance
      - "${HOME}/.vscode-server:exec"
    volumes:
      - /data:/data
      - $HOME:/${USER:-zyin}
