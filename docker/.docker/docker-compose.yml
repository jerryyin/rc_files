volumes:
  tools_volume:
    external: false

x-base-service: &base-service
  container_name: ${COMPOSE_PROJECT_NAME:-dev}
  hostname: ${COMPOSE_PROJECT_NAME:-zyin}
  command: ["bash", "-c", "scripts/docker/env/priv.sh && exec /bin/zsh"]
  tty: true
  stdin_open: true
  network_mode: host
  devices:
    - /dev/kfd
    - /dev/dri
  group_add:
    - video
  cap_add:
    - SYS_PTRACE
  security_opt:
    - seccomp=unconfined
  tmpfs:
    - "${HOME}/.vscode-server:exec"
  volumes:
    - /data:/data
    - $HOME:/zyin
    - tools_volume:/usr/local  # Mount tools volume into /usr/local

services:
  tools-setup:
    command: ["/bin/sh", "-c", "cp -r /usr/local/* /tools || true"]
    tty: true
    stdin_open: true
    build:
      context: .
      dockerfile: tools.dockerfile  # Build tools image as usual
      args:
        BASE_IMAGE: ubuntu:24.04
        SERVICE_NAME: tools-setup
    image: jeryin/dev:tools
    container_name: zyin-tools-setup
    volumes:
      - tools_volume:/tools  # Mount volume to receive tools
    restart: "no"

  base:
    <<: *base-service
    build:
      context: .
      dockerfile: base.dockerfile
      args:
        BASE_IMAGE: rocm/dev-ubuntu-24.04:latest
        SERVICE_NAME: base
    image: "jeryin/dev:base"
    depends_on:
      - tools-setup  # Ensure tools-setup runs first
    profiles: ["base"]

  rocmlir:
    <<: *base-service
    build:
      context: ..
      dockerfile: .docker/base.dockerfile
      args:
        BASE_IMAGE: rocm/mlir:latest
        SERVICE_NAME: rocmlir
    image: "jeryin/dev:rocmlir"
    depends_on:
      - tools-setup  # Ensure tools-setup runs first
    profiles: ["rocmlir"]

  ck:
    <<: *base-service
    build:
      context: ..
      dockerfile: .docker/base.dockerfile
      args:
        BASE_IMAGE: rocm/composable_kernel:ck_ub24.04_rocm7.0.1_amd-staging
        SERVICE_NAME: ck
    image: "jeryin/dev:ck"
    depends_on:
      - tools-setup  # Ensure tools-setup runs first
    profiles: ["ck"]

  triton:
    <<: *base-service
    build:
      context: ..
      dockerfile: .docker/base.dockerfile
      args:
        BASE_IMAGE: rocm/pytorch:latest
        SERVICE_NAME: triton
    image: "jeryin/dev:triton"
    depends_on:
      - tools-setup  # Ensure tools-setup runs first
    profiles: ["triton"]

  mi450:
    build:
      context: ..
      dockerfile: scripts/docker/triton-mi450.dockerfile
      args:
        DOCKER_USERID: "32000"
        DOCKER_GROUPID: "32000"
        DOCKER_RENDERID: "107"  # render group GID so mirror user can access GPU nodes
        USE_NPI_ROCM: "TRUE"
        USE_NPI_TORCH: "TRUE"
        ROCM_BUILD_NUMBER: "710"
    image: "jeryin/dev:mi450"
    profiles: ["triton-mi450"]

  triton-mi450:
    <<: *base-service
    build:
      context: ..
      dockerfile: .docker/base.dockerfile
      args:
        BASE_IMAGE: jeryin/dev:mi450
        SERVICE_NAME: triton
    image: "jeryin/dev:triton-mi450"
    depends_on:
      - tools-setup
      - mi450
    profiles: ["triton-mi450"]

  iree:
    <<: *base-service
    build:
      context: ..
      dockerfile: .docker/base.dockerfile
      args:
        BASE_IMAGE: rocm/dev-ubuntu-24.04:latest
        SERVICE_NAME: iree
    image: "jeryin/dev:iree"
    depends_on:
      - tools-setup  # Ensure tools-setup runs first


